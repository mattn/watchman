# Strict compilation, but suppress deprecation of POSIX and a couple of
# warnings that get generated by the system headers
PEDANTIC=-Wall
CC=gcc
CPP=g++
MAKEDIR=.
CFLAGS=-I$(MAKEDIR)/winbuild -I$(MAKEDIR) -I$(MAKEDIR)/thirdparty/jansson -I$(MAKEDIR)/thirdparty/wildmatch --std=c99
CXXFLAGS=-I$(MAKEDIR)/winbuild -I$(MAKEDIR) -I$(MAKEDIR)/thirdparty/jansson -I$(MAKEDIR)/thirdparty/wildmatch
LIBS=-lshlwapi -ladvapi32 -ldbghelp -lpthread
LINKER=g++ -o $@

JSON_SRCS=\
	thirdparty/jansson/dump.cpp \
	thirdparty/jansson/error.cpp \
	thirdparty/jansson/load.cpp \
	thirdparty/jansson/memory.cpp \
	thirdparty/jansson/pack_unpack.cpp \
	thirdparty/jansson/strbuffer.cpp \
	thirdparty/jansson/strconv.cpp \
	thirdparty/jansson/utf.cpp \
	thirdparty/jansson/value.cpp

WILDMATCH_SRC=\
	thirdparty/wildmatch/wildmatch.c

SRCS=\
	$(JSON_SRCS) \
	$(WILDMATCH_SRC) \
	winbuild/errmap.cpp \
	winbuild/pathmap.cpp \
	winbuild/dir.cpp \
	winbuild/mkdir.cpp \
	winbuild/asprintf.cpp \
	winbuild/hostname.cpp \
	winbuild/time.cpp \
	winbuild/backtrace.cpp \
	winbuild/getopt_long.cpp \
	winbuild/posix_spawn.cpp \
	ignore.cpp \
	spawn.cpp \
	opt.cpp \
	cfg.cpp \
	clockspec.cpp \
	checksock.cpp \
	fstype.cpp     \
	log.cpp        \
	json.cpp       \
	bser.cpp       \
	expflags.cpp   \
	hash.cpp       \
	ioprio.cpp     \
	opendir.cpp    \
	pending.cpp    \
	perf.cpp       \
	stream.cpp     \
	stream_win.cpp \
	stream_stdout.cpp \
	cmds/find.cpp     \
	cmds/info.cpp     \
	cmds/log.cpp      \
	cmds/query.cpp    \
	cmds/since.cpp    \
	cmds/reg.cpp      \
	cmds/state.cpp    \
	cmds/subscribe.cpp    \
	cmds/trigger.cpp  \
	cmds/watch.cpp    \
	cmds/debug.cpp    \
	query/base.cpp       \
	query/parse.cpp      \
	query/dirname.cpp    \
	query/eval.cpp       \
	query/glob.cpp       \
	query/type.cpp       \
	query/suffix.cpp     \
	query/match.cpp      \
	query/pcre.cpp       \
	query/name.cpp       \
	query/fieldlist.cpp  \
	query/intcompare.cpp  \
	query/since.cpp      \
	query/empty.cpp      \
	watcher/auto.cpp \
	watcher/win32.cpp \
	listener.cpp   \
	listener-user.cpp   \
	clientmode.cpp \
	main.cpp       \
	root/ageout.cpp       \
	root/crawler.cpp       \
	root/dir.cpp       \
	root/file.cpp       \
	root/init.cpp       \
	root/iothread.cpp       \
	root/notifythread.cpp       \
	root/poison.cpp       \
	root/reap.cpp       \
	root/resolve.cpp       \
	root/stat.cpp       \
	root/symlink.cpp       \
	root/sync.cpp       \
	root/threading.cpp       \
	root/vcs.cpp       \
	root/warnerr.cpp       \
	root/watchlist.cpp       \
	state.cpp      \
	string.cpp     \
	time.cpp \
	InMemoryView.cpp \
	PubSub.cpp \
	ContentHash.cpp \
	FileDescriptor.cpp \
	FileInformation.cpp \
	scm/Mercurial.cpp \
	scm/SCM.cpp \
	ChildProcess.cpp \
	QueryableView.cpp \
	CookieSync.cpp \
	Pipe.cpp \
	ThreadPool.cpp \
	error_category.cpp

OBJS=$(SRCS:.cpp=.o)
DEPS=$(SRCS:.cpp=.dep) $(TEST_SRCS:.c=.dep) $(TEST_DIR_SRCS:.c=.dep)

.cpp.o:
	@echo CPP $<
	$(CPP) $(CXXFLAGS) $(PEDANTIC) -I. -o $@ -c $<

.c.o:
	@echo CC $<
	$(CC) $(CFLAGS) $(PEDANTIC) -I. -o $@ -c $<

all: remove-config-h watchman.exe

remove-config-h:
	-@echo rm config.h watchman

# problems with vcvarsall.bat? http://stackoverflow.com/a/10558328/149111
py-build:
	cd python && python ./setup.py clean build_py -c -d . build_ext -i

py-integration: py-build
	python -u runtests.py

integration: build-tests susres.exe py-integration

build-tests: $(TESTS)

watchman.exe: $(OBJS)
	@echo LINK $@
	$(LINKER) $(OBJS) $(LIBS)


